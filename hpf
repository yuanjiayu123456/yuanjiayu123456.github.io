# -*- coding: utf-8 -*-
import numpy as np
import matplotlib.pyplot as plt
import os

# ==========================================
# é…ç½®åŒºåŸŸ
# ==========================================
CONFIG = {
    'fs': 31250.0,
    'in_file': 'data/data_iq_out.dat',   # è¾“å…¥æ–‡ä»¶è·¯å¾„
    'out_file': 'data/data_hpf_out.dat', # è¾“å‡ºæ–‡ä»¶è·¯å¾„
    'plot_file': 'output/step5_dc_latch_delayed.png',
    
    # 1. è·³è¿‡æ—¶é—´ (Skip)
    # å¿½ç•¥å‰ 64 ä¸ªç‚¹ (çº¦ 2ms)ï¼Œç­‰å¾…ç¡¬ä»¶ä¸Šç”µç¨³å®šæˆ–ç¬æ€ç»“æŸ
    'skip_len': 64, 
    
    # 2. é”å®šæ—¶é—´ (Latch/Measure)
    # è·³è¿‡ä¹‹åï¼Œåˆ©ç”¨æ¥ä¸‹æ¥çš„ 64 ä¸ªç‚¹è®¡ç®—å¹³å‡ DC å€¼
    'latch_len': 64 
}

class DC_Latch_Hardware:
    """
    ç¡¬ä»¶è¡Œä¸ºæ¨¡æ‹Ÿï¼š
    1. Wait/Skip: å¯åŠ¨åå…ˆç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä¸é‡‡æ ·ã€‚
    2. Calibrate: å¼€å§‹ç´¯åŠ è®¡ç®—å¹³å‡å€¼ã€‚
    3. Run: é”å®šå¹³å‡å€¼ï¼Œæ‰§è¡Œå‡æ³•ã€‚
    """
    def __init__(self, skip_len, latch_len):
        self.skip_len = skip_len    # è·³è¿‡ç‚¹æ•°
        self.latch_len = latch_len  # é‡‡æ ·ç‚¹æ•°
        self.counter = 0            # å…¨å±€è®¡æ•°å™¨
        self.accumulator = 0.0      # ç´¯åŠ å™¨
        self.locked_dc = 0.0        # é”å®šçš„ DC å€¼
        self.calibrated = False     # çŠ¶æ€æ ‡å¿—

    def process(self, x_float):
        # é˜¶æ®µ 1: ç­‰å¾…/è·³è¿‡é˜¶æ®µ (Wait / Skip)
        if self.counter < self.skip_len:
            self.counter += 1
            # åœ¨è·³è¿‡é˜¶æ®µï¼Œé€šå¸¸è¾“å‡º Mute (0) æˆ–è€… bypassï¼Œè¿™é‡Œé€‰æ‹© Mute
            return 0.0 
            
        # é˜¶æ®µ 2: æ ¡å‡†é˜¶æ®µ (Calibration / Accumulate)
        # åªæœ‰è¿‡äº† skip_len ä¹‹åæ‰å¼€å§‹ç´¯åŠ 
        elif self.counter < (self.skip_len + self.latch_len):
            self.accumulator += x_float
            self.counter += 1
            
            # åˆ¤æ–­æ˜¯å¦åˆšå¥½æ”¶é›†æ»¡ latch_len ä¸ªç‚¹
            if self.counter == (self.skip_len + self.latch_len):
                # è®¡ç®—å¹³å‡å€¼å¹¶é”å®š
                self.locked_dc = self.accumulator / self.latch_len
                print(f"ğŸ”’ ç¡¬ä»¶æ ¡å‡†å®Œæˆ (Skip {self.skip_len} + Latch {self.latch_len}): Locked DC = {self.locked_dc:.8f}")
                self.calibrated = True
            
            # æ ¡å‡†æœŸé—´å»ºè®® Muteï¼Œé˜²æ­¢è¾“å‡ºä¸ç¨³å®šçš„ç›´æµè·³å˜
            return 0.0 
            
        # é˜¶æ®µ 3: é”å®šå·¥ä½œé˜¶æ®µ (Operation)
        else:
            # æ­¤æ—¶ locked_dc å·²ç»å›ºå®šï¼Œä¸å†å˜åŒ–
            # è¿™æ˜¯ä¸€ä¸ªçº¯å‡æ³•æ“ä½œï¼Œæ²¡æœ‰ä»»ä½•æ»¤æ³¢å™¨å¸¦æ¥çš„ç›¸ä½ç•¸å˜
            out = x_float - self.locked_dc
            return out

def main():
    # ç®€å•çš„æ–‡ä»¶æ£€æŸ¥
    if not os.path.exists(CONFIG['in_file']):
        print(f"Warning: {CONFIG['in_file']} not found. Generating dummy data for demonstration.")
        # ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼šå‰100ä¸ªç‚¹æ˜¯ä¹±åºå™ªéŸ³ï¼Œåé¢æ˜¯å¸¦ç›´æµåç½®çš„æ­£å¼¦æ³¢
        t = np.arange(1000)
        dummy_noise = np.random.normal(0, 0.1, 100) + 0.5 # ç¬æ€å™ªéŸ³
        dummy_signal = np.sin(2 * np.pi * t[100:] / 50) + 2.5 # ç¨³å®šä¿¡å· DC=2.5
        iq_data = np.concatenate([dummy_noise, dummy_signal])
    else:
        iq_data = np.loadtxt(CONFIG['in_file'])
    
    # åˆå§‹åŒ–ä¼ å…¥ skip å’Œ latch å‚æ•°
    dc_remover = DC_Latch_Hardware(CONFIG['skip_len'], CONFIG['latch_len'])
    
    out_data = []
    for val in iq_data:
        out_data.append(dc_remover.process(val))
    out_data = np.array(out_data)
    
    # ä¿å­˜æ•°æ®
    # Ensure directory exists
    os.makedirs(os.path.dirname(CONFIG['out_file']), exist_ok=True)
    np.savetxt(CONFIG['out_file'], out_data, fmt='%.8f')

    # ==========================================
    # ç»˜å›¾éƒ¨åˆ†
    # ==========================================
    try:
        plt.style.use('seaborn-v0_8-paper')
    except:
        plt.style.use('ggplot') # Fallback style

    fig, ax = plt.subplots(2, 1, figsize=(10, 8), dpi=150)
    
    # å›¾1: åŸå§‹è¾“å…¥
    ax[0].plot(iq_data, 'orange', label='Input (Raw)')
    
    # ç”»å‡º Skip å’Œ Latch çš„åŒºåŸŸç¤ºæ„
    # ç°è‰²åŒºåŸŸï¼šSkip
    ax[0].axvspan(0, CONFIG['skip_len'], color='gray', alpha=0.3, label='Skip Phase (Ignored)')
    # ç»¿è‰²åŒºåŸŸï¼šLatch (Calibration)
    ax[0].axvspan(CONFIG['skip_len'], CONFIG['skip_len'] + CONFIG['latch_len'], color='green', alpha=0.2, label='Latch Phase (Measure DC)')
    
    ax[0].legend(loc='upper right')
    ax[0].set_title(f'Input Signal Processing Phases (Skip={CONFIG["skip_len"]}, Latch={CONFIG["latch_len"]})')
    ax[0].set_ylabel('Amplitude')
    
    # å›¾2: å¤„ç†åè¾“å‡º
    ax[1].plot(out_data, '#1f77b4', lw=1.5, label='Output (DC Removed)')
    ax[1].set_title('Output via "Delayed Latch" (Start -> Skip -> Measure -> Lock)')
    ax[1].axhline(0, color='black', alpha=0.3)
    ax[1].set_ylabel('Amplitude')
    ax[1].grid(True, alpha=0.3)
    
    # æ ‡æ³¨çœŸæ­£å¼€å§‹è¾“å‡ºçš„æ—¶é—´ç‚¹
    start_output_idx = CONFIG['skip_len'] + CONFIG['latch_len']
    ax[1].axvline(start_output_idx, color='red', linestyle='--', alpha=0.5)
    
    # åŠ¨æ€è°ƒæ•´æ–‡æœ¬ä½ç½®
    y_pos = np.max(out_data) * 0.8 if len(out_data) > 0 else 0
    ax[1].text(start_output_idx + 10, y_pos, "Output Enabled Here ->", color='red', fontweight='bold')

    plt.tight_layout()
    
    # Ensure output directory exists
    os.makedirs(os.path.dirname(CONFIG['plot_file']), exist_ok=True)
    plt.savefig(CONFIG['plot_file'])
    print(f"âœ… Plot saved to: {CONFIG['plot_file']}")

if __name__ == "__main__":
    main()
